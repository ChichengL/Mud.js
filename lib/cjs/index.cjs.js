"use strict";class t{constructor(){this.viewers=[]}addViewer(t){this.viewers.push(t)}publish(){this.viewers.forEach((t=>{t.update()}))}}const e=t=>null!==t&&"object"==typeof t;class n{constructor(e){this.publisher=new t,this.obj2Proxy=new WeakMap,e.data=this.hijack(e.data)}hijack(n){const o=this;return e(n)?new Proxy(n,{get(n,s,i){const r=Reflect.get(n,s,i);if(t.viewer&&o.publisher.addViewer(t.viewer),e(r)){const t=o.obj2Proxy.get(r);if(t)return t;{const t=o.hijack(r);o.obj2Proxy.set(r,t)}}return r},set(t,e,n,s){const i=Reflect.set(t,e,n,s);return o.publisher.publish(),i},deleteProperty(t,e){const n=Reflect.deleteProperty(t,e);return o.publisher.publish(),n}}):n}}class o{constructor(e,n,o,s){this.mud=e,this.dataKey=n,this.updateHandler=o,this.node=s,t.viewer=this,this.oldValue=e.data[n],t.viewer=null}update(){const t=this.mud.data[this.dataKey];((t,e)=>{const n=typeof t;return n!==typeof e||(["function","object"].includes(n)?t.toString()!==e.toString():t!==e)})(this.oldValue,t)&&(this.oldValue=t,this.node?this.updateHandler(t,this.node):this.updateHandler(t))}}const s=(t,e)=>{const n=e.split(".");if(n.length>1){const e=n.pop(),o=n.reduce(((t,e)=>t[e]),t.data);return[o[e],t=>{o[e]=t}]}{const e=n[0],o=t.data;return[o[e],t=>{o[e]=t}]}},i=(t,e,n)=>{const{name:s,value:i}=n;if("m-if"===s){const n=t.data[i];let s=null;const r=(t,e)=>{t?s&&s.parentNode.replaceChild(e,s):s=(t=>{const e=document.createComment("if");return t.parentNode?.replaceChild(e,t),e})(e)};new o(t,i,r,e),r(n,e)}};class r{constructor(t){this.mud=t,this.el=t.el,this.compile(this.el)}compile(t){const e=t.childNodes;Array.from(e).forEach((t=>{1===t.nodeType?this.compileForElement(t):3===t.nodeType&&this.compileForText(t),t.childNodes.length&&this.compile(t)}))}compileForElement(t){Array.from(t.attributes).forEach((e=>{((t,e,n,i)=>{const{name:r,value:c}=n;if("props"===r)return;const a=/\{(.+?)\}/,d=c?.match(a);if(d){const n=d[1],[i,l]=s(t,n);if(void 0===i)return;const h=t=>{e[r]=t};new o(t,n,h),e.addEventListener("input",(()=>{l(e.value)})),h(c.replace(a,i))}})(this.mud,t,e),((t,e,n)=>{const{name:s,value:i}=n;if("for"===s){const[n,s]=i.split(":"),r=t.data[s],c=new RegExp(`{${n}}`),a=`${e.innerHTML}`,d=(t,e)=>{const n=t?.reduce(((t,e)=>{let n=a;return a.match(c)&&(n=a.replace(c,e)),t+n}),"");e.innerHTML=n};new o(t,s,d,e),d(r,e)}})(this.mud,t,e),i(this.mud,t,e)})),((t,e)=>{const n=e.tagName?.toLowerCase(),s=t?.components?.[n];if(!s)return;const i=document.createElement("iframe"),r=()=>{const t=i.contentDocument;i.width=t?.body?.offsetWidth??0,i.height=t?.body?.scrollHeight??0},c=e.attributes?.props?.nodeValue,a=c?.match(/\{(.+?)\}/);i.height=0,i.scrolling="no",i.style.width="100%",i.style.border="none",i.src=s,i.onload=()=>{const e=i.contentDocument,n=i.contentWindow;a&&a[1].split(",")?.forEach((e=>{const s=e.trim().split(":"),i=s[0],r=s[1]??i;n.mud.data[i]=t.data?.[r],new o(t,r,(t=>{n.mud.data[i]=t})),n.mud.watch(i,(e=>{t.data[r]=e}))})),e.head.innerHTML='\n      <META HTTP-EQUIV="pragma" CONTENT="no-cache">\n      <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">\n      <META HTTP-EQUIV="expires" CONTENT="0">\n    ',e.body.style.margin=0,e.body.addEventListener("DOMSubtreeModified",(()=>{r()}),!1),r()},e.appendChild(i)})(this.mud,t)}compileForText(t){((t,e,n)=>{const i=/\{(.+?)\}/,r=n.match(i);if(r){const c=r[1],[a]=s(t,c);if(void 0===a)return;const d=t=>{e.textContent=t};new o(t,c,d),d(n.replace(i,a))}})(this.mud,t,t.textContent)}}module.exports=class{constructor(t){window.mud=this,this.el=document.querySelector(t.el),this.data=t.data,this.components=t.components,this.watch=(t,e)=>{new o(this,t,e)},new n(this),new r(this)}},"undefined"!=typeof window&&(window.MUD_VERSION="1.1.3");
