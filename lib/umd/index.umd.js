!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Mud=t()}(this,(function(){"use strict";class e{constructor(){this.viewers=[]}addViewer(e){this.viewers.push(e)}publish(){this.viewers.forEach((e=>{e.update()}))}}const t=e=>null!==e&&"object"==typeof e;class n{constructor(t){this.publisher=new e,this.obj2Proxy=new WeakMap,t.data=this.hijack(t.data)}hijack(n){const o=this;return t(n)?new Proxy(n,{get(n,s,i){const r=Reflect.get(n,s,i);if(e.viewer&&o.publisher.addViewer(e.viewer),t(r)){const e=o.obj2Proxy.get(r);if(e)return e;{const e=o.hijack(r);o.obj2Proxy.set(r,e)}}return r},set(e,t,n,s){const i=Reflect.set(e,t,n,s);return o.publisher.publish(),i},deleteProperty(e,t){const n=Reflect.deleteProperty(e,t);return o.publisher.publish(),n}}):n}}const o=(e,t)=>{const n=t.split(".");if(n.length>1){const t=n.pop(),o=n.reduce(((e,t)=>e[t]),e.data);return[o[t],e=>{o[t]=e}]}{const t=n[0],o=e.data;return[o[t],e=>{o[t]=e}]}},s=e=>{if("object"===typeof e){if(Array.isArray(e))return Array.from(e);{const t={};return Object.keys(e)?.forEach((e=>{t[e]=s(t[e])})),t}}return e};class i{constructor(t,n,i,r,l,a){this.mud=t,this.dataKey=n,this.updateHandler=i,this.node=r,this.ifNodeList=l,this.num=a,e.viewer=this,this.oldValue=s(o(t,n)[0]),e.viewer=null}update(){const e=o(this.mud,this.dataKey)[0];((e,t)=>{const n=typeof e;return n!==typeof t||(["function","object"].includes(n)?e.toString()!==t.toString():e!==t)})(this.oldValue,e)&&(this.ifNodeList&&(this.oldValue=e,this.dataKey,this.ifNodeList[this.num].datakey=e),this.node?this.updateHandler(this.ifNodeList):(this.oldValue=s(e),this.updateHandler(e,this.node)))}}const r=(e,t)=>{if(t)return t.parentNode||e.parentNode.replaceChild(t,e),t;{const t=document.createComment("m-if");return e.parentNode.replaceChild(t,e),t}},l=(e,t)=>{t.parentNode.replaceChild(e,t)};class a{constructor(e){this.mud=e,this.el=e.el,this.compile(this.el)}compile(e){const t=e.childNodes;Array.from(t).forEach((e=>{1===e.nodeType?this.compileForElement(e):3===e.nodeType&&this.compileForText(e),e.childNodes.length&&this.compile(e)}))}compileForElement(e){Array.from(e.attributes).forEach((t=>{((e,t,n)=>{const{name:s,value:r}=n;if("props"===s)return;const l=/\{(.+?)\}/,a=r?.match(l);if(a){const n=a[1],[d,c]=o(e,n);if(void 0===d)return;const u=e=>{t[s]=e};new i(e,n,u),t.addEventListener("input",(()=>{c(t.value)})),u(r.replace(l,d))}})(this.mud,e,t),((e,t,n)=>{const{name:o,value:s}=n;if("for"===o){const[n,o]=s.split(":").map((e=>e?.trim())),r=e.data[o],l=new RegExp(`{${n}}`),a=`${t.innerHTML}`,d=(e,t)=>{const n=e?.reduce(((e,t)=>{let n=a;return a.match(l)&&(n=a.replace(l,t)),e+n}),"");t.innerHTML=n};new i(e,o,d,t),d(r,t)}})(this.mud,e,t),((e,t,n)=>{const{name:o,value:s}=n;let a=null;if("if"!==o)return;a=((e,t,n)=>{let o=[];return o.push({node:e,name:t,value:n}),function e(t){if(void 0===t.nextElementSibling.attributes[0])return o;const{name:n,value:s}=t.nextElementSibling.attributes[0];return"else-if"===n?(o.push({node:t.nextElementSibling,name:n,value:s}),e(t.nextElementSibling)):"else"===n?(o.push({node:t.nextElementSibling,name:n,value:s}),o):o}(e)})(t,o,s);let d=new Map;const c=t=>{let n=t.length;if("else"!=t[n-1].name){for(let o=0;o<n;o++){const s=e.data[t[o].value];if(0===o){if(s){d.get(u[o])&&(l(t[o].node,u[o]),d.set(u[o],!1));for(let e=1;e<n;e++)u[e]=r(t[e].node,u[e]),d.set(u[e],!0);break}u[o]=r(t[o].node,u[o]),d.set(u[o],!0)}else{if(s){d.get(u[o])&&(l(t[o].node,u[o]),d.set(u[o],!1),console.log("其他恢复"));for(let e=o+1;e<n;e++)u[e]=r(t[e].node,u[e]),d.set(u[e],!0);break}u[o]=r(t[o].node,u[o]),d.set(u[o],!0)}}console.log("wuelse")}else for(let o=0;o<n;o++){const s=e.data[t[o].value];if(0===o){if(s){d.get(u[o])&&(l(t[o].node,u[o]),d.set(u[o],!1));for(let e=1;e<n;e++)u[e]=r(t[e].node,u[e]),d.set(u[e],!0);break}u[o]=r(t[o].node,u[o]),d.set(u[o],!0)}else{if(o===n-1){d.get(u[o])&&(l(t[o].node,u[o]),d.set(u[o],!1));break}if(s){d.get(u[o])&&(l(t[o].node,u[o]),d.set(u[o],!1),console.log("其他恢复"));for(let e=o+1;e<n;e++)u[e]=r(t[e].node,u[e]),d.set(u[e],!0);break}u[o]=r(t[o].node,u[o]),d.set(u[o],!0)}}};for(let t=0;t<a.length;t++)new i(e,a[t].value,c,a[t].node,a,t);let u=Array(a.length);c(a)})(this.mud,e,t)})),((e,t)=>{const n=t.tagName?.toLowerCase(),s=e?.components?.[n];if(!s)return;const r=document.createElement("iframe"),l=()=>{const e=r.contentDocument;r.width=e?.body?.offsetWidth||0,r.height=e?.body?.scrollHeight||0},a=t.attributes?.props?.nodeValue,d=a?.match(/\{(.+?)\}/);r.height=0,r.scrolling="no",r.style.width="100%",r.style.border="none",r.src=s,r.onload=()=>{const t=r.contentDocument,n=r.contentWindow;d&&d[1].split(",")?.forEach((t=>{const s=t.trim().split(":"),r=s[0],l=s[1]??r,[a,d]=o(e,l);n.mud.data[r]=a,new i(e,l,(e=>{n.mud.data[r]=e})),n.mud.watch(r,(e=>{d(e)}))})),t.head.innerHTML='\n      <META HTTP-EQUIV="pragma" CONTENT="no-cache">\n      <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">\n      <META HTTP-EQUIV="expires" CONTENT="0">\n    ',t.body.style.margin=0,t.body.addEventListener("DOMSubtreeModified",(()=>{l()}),!1),l()},t.appendChild(r)})(this.mud,e)}compileForText(e){((e,t,n)=>{const s=/\{(.+?)\}/,r=n.match(s);if(r){const l=r[1],[a]=o(e,l);if(void 0===a)return;const d=e=>{t.textContent=n.replace(s,e)};new i(e,l,d),d(a)}})(this.mud,e,e.textContent)}}return class{constructor(e){window.mud=this,this.el=document.querySelector(e.el),this.data=e.data,this.components=e.components,this.watch=(e,t)=>{new i(this,e,t)},new n(this),new a(this),e.onMount?.()}}})),"undefined"!=typeof window&&(window.MUD_VERSION="1.2.1");
