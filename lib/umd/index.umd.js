!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Mud=t()}(this,(function(){"use strict";class e{constructor(){this.viewers=[]}addViewer(e){this.viewers.push(e)}publish(){this.viewers.forEach((e=>{e.update()}))}}const t=e=>null!==e&&"object"==typeof e;class n{constructor(t){this.publisher=new e,this.obj2Proxy=new WeakMap,t.data=this.hijack(t.data)}hijack(n){const o=this;return t(n)?new Proxy(n,{get(n,s,i){const r=Reflect.get(n,s,i);if(e.viewer&&o.publisher.addViewer(e.viewer),t(r)){const e=o.obj2Proxy.get(r);if(e)return e;{const e=o.hijack(r);o.obj2Proxy.set(r,e)}}return r},set(e,t,n,s){const i=Reflect.set(e,t,n,s);return o.publisher.publish(),i},deleteProperty(e,t){const n=Reflect.deleteProperty(e,t);return o.publisher.publish(),n}}):n}}class o{constructor(t,n,o,s){this.mud=t,this.dataKey=n,this.updateHandler=o,this.node=s,e.viewer=this,this.oldValue=t.data[n],e.viewer=null}update(){const e=this.mud.data[this.dataKey];((e,t)=>{const n=typeof e;return n!==typeof t||(["function","object"].includes(n)?e.toString()!==t.toString():e!==t)})(this.oldValue,e)&&(this.oldValue=e,this.node?this.updateHandler(e,this.node):this.updateHandler(e))}}const s=(e,t,n,s)=>{const i=/\{(.+?)\}/,r=n.match(i);if(r){const c=r[1],[a,l]=((e,t)=>{const n=t.split(".");if(n.length>1){const t=n.pop(),o=n.reduce(((e,t)=>e[t]),e.data);return[o[t],e=>{o[t]=e}]}{const t=n[0],o=e.data;return[o[t],e=>{o[t]=e}]}})(e,c);if(!a)return a;const d=s?e=>{t.value=e}:e=>{t.textContent=e};new o(e,c,d),s&&t.addEventListener("input",(()=>{l(t.value)}));d(n.replace(i,a))}},i=(e,t,n)=>{const{name:s,value:i}=n;if("m-if"===s){const n=e.data[i];let s=null;const r=(e,t)=>{e?s&&s.parentNode.replaceChild(t,s):s=(e=>{const t=document.createComment("if");return e.parentNode?.replaceChild(t,e),t})(t)};new o(e,i,r,t),r(n,t)}};class r{constructor(e){this.mud=e,this.el=e.el,this.compile(this.el)}compile(e){const t=e.childNodes;Array.from(t).forEach((e=>{1===e.nodeType?this.compileForElement(e):3===e.nodeType&&this.compileForText(e),e.childNodes.length&&this.compile(e)}))}compileForElement(e){Array.from(e.attributes).forEach((t=>{const{name:n,value:r}=t;this.mud,s(this.mud,e,r,!0),((e,t,n)=>{const{name:s,value:i}=n;if("for"===s){const[n,s]=i.split(":"),r=e.data[s],c=new RegExp(`{${n}}`),a=`${t.innerHTML}`,l=(e,t)=>{const n=e?.reduce(((e,t)=>{let n=a;return a.match(c)&&(n=a.replace(c,t)),e+n}),"");t.innerHTML=n};new o(e,s,l,t),l(r,t)}})(this.mud,e,t),i(this.mud,e,t)}))}compileForText(e){s(this.mud,e,e.textContent,!1)}}return class{constructor(e){this.el=document.querySelector(e.el),this.data=e.data,this.components=e.components,new n(this),new r(this)}}})),"undefined"!=typeof window&&(window.MUD_VERSION="1.1.3");
